# PRD: 공유 기능 재설계 및 구현

## 개요
공유 가계부 앱의 공유 기능을 재설계하여 RLS 보안을 강화하고, 이메일 기반 초대 시스템을 구현합니다.

## 현재 문제
1. RLS(Row Level Security)가 비활성화되어 모든 사용자 데이터가 노출됨
2. 신규 계정 생성 시 다른 사용자의 데이터가 표시됨
3. 공유 기능이 제대로 작동하지 않음

## 요구사항

### FR-1: 이메일로 초대
- 사용자는 상대방 이메일을 입력하여 가계부 공유 초대를 보낼 수 있다
- 초대 시 역할(admin/member)을 선택할 수 있다
- 존재하지 않는 이메일로는 초대할 수 없다 (가입된 사용자만)
- 이미 멤버인 사용자에게는 초대를 보낼 수 없다

### FR-2: 초대 수락/거절
- 초대받은 사용자는 앱에서 초대 목록을 확인할 수 있다
- 초대를 수락하면 해당 가계부의 멤버가 된다
- 초대를 거절하면 초대가 삭제된다
- 보낸 초대는 취소할 수 있다

### FR-3: 데이터 공유
- 공유 관계가 맺어지면 해당 가계부의 모든 거래 내역을 볼 수 있다
- 이전 내역도 모두 공유된다
- 각 거래에는 작성자가 표시된다

### FR-4: 공유 해제
- 가계부 소유자는 멤버를 제거할 수 있다
- 멤버 본인은 가계부에서 나갈 수 있다
- 공유 해제 즉시 해당 가계부에 대한 모든 접근이 차단된다

### FR-5: 역할별 권한
| 역할 | 거래 CRUD | 카테고리 수정 | 예산 수정 | 멤버 관리 | 가계부 삭제 |
|------|----------|-------------|----------|----------|-----------|
| owner | O | O | O | O | O |
| admin | O | O | O | O | X |
| member | O | X | X | X | X |

## 비기능 요구사항

### NFR-1: 보안
- 모든 테이블에 RLS가 활성화되어야 한다
- 사용자는 본인이 소유하거나 멤버인 가계부의 데이터만 접근할 수 있다

### NFR-2: 데이터 정합성
- 기존 테스트 데이터는 삭제 후 새로 시작
- 가계부 생성 시 기본 카테고리가 자동 생성되어야 한다

## 기술 스택
- Backend: Supabase (PostgreSQL + RLS)
- Frontend: Flutter + Riverpod
- 기존 테이블: profiles, ledgers, ledger_members, ledger_invites, categories, transactions, budgets

## 영향받는 파일
- `supabase/migrations/` - RLS 정책 마이그레이션
- `lib/features/share/` - 공유 기능 전체
- `lib/features/ledger/` - 가계부 목록 조회 로직
- `lib/features/transaction/` - 거래 내역 조회 로직
