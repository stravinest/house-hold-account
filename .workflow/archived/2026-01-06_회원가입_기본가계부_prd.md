# PRD: 회원가입 시 기본 가계부 자동 생성

## 배경 및 목적

- 회원가입 후 가계부가 0개인 상태에서 초대 기능이 작동하지 않는 문제 해결
- 신규 사용자가 별도의 가계부 생성 과정 없이 바로 앱을 사용할 수 있도록 개선
- backlog의 "기본 가계부 처리 개선" 문제를 근본적으로 해결

## 구현 방식: 옵션 C (이중 안전장치)

DB 트리거(Primary)와 Flutter 앱(Secondary) 이중 안전장치로 100% 가계부 생성 보장

## 필수 요구사항

### 기능 요구사항

- [ ] 회원가입 완료 시 "내 가계부" 자동 생성
- [ ] 기본 가계부 설정: name="내 가계부", currency="KRW"
- [ ] DB 트리거 실패 시 앱에서 백업으로 생성
- [ ] 기존 사용자에게는 영향 없음 (신규 가입만 적용)

### 기술 요구사항

#### 1. DB 마이그레이션 (Primary)
- [ ] 파일: `supabase/migrations/003_auto_create_default_ledger.sql`
- [ ] `handle_new_user()` 트리거 함수 수정
- [ ] profiles 생성 직후 기본 가계부 자동 생성 로직 추가
- [ ] SECURITY DEFINER로 RLS 우회 (트리거 내부에서 실행)

#### 2. Flutter 앱 검증 로직 (Secondary)
- [ ] 파일: `lib/features/auth/presentation/providers/auth_provider.dart`
- [ ] `signUpWithEmail()` 성공 후 가계부 개수 확인
- [ ] 0개면 자동으로 "내 가계부" 생성
- [ ] 에러 발생 시에도 회원가입은 완료 처리 (가계부 생성 실패를 silent 처리)

### 데이터 모델

#### 기본 가계부 생성 시 설정값
```dart
{
  'name': '내 가계부',
  'currency': 'KRW',
  'owner_id': user.id,
  'is_shared': false
}
```

### API 연동

#### Supabase 테이블
- `ledgers`: 기본 가계부 INSERT
- `ledger_members`: owner role로 자동 추가 (기존 트리거 `on_ledger_created` 활용)
- `categories`: 기본 카테고리 자동 생성 (기존 트리거 `on_ledger_created_categories` 활용)

### 상태 관리

#### Riverpod Provider
- `AuthService.signUpWithEmail()`: 회원가입 성공 후 백업 가계부 생성 로직 추가
- `LedgerRepository.getLedgers()`: 가계부 목록 조회 (검증용)
- `LedgerRepository.createLedger()`: 백업 가계부 생성용

## 성공 기준

- [ ] 신규 회원가입 시 가계부가 정확히 1개 생성됨
- [ ] 생성된 가계부 이름이 "내 가계부"임
- [ ] 생성된 가계부에 기본 카테고리가 포함됨
- [ ] 기존 사용자 데이터에 영향 없음
- [ ] DB 트리거 실패 시에도 앱에서 가계부 생성 성공
- [ ] flutter test 통과
- [ ] flutter analyze 경고 없음
- [ ] flutter build 성공

## 주의사항

1. **에러 처리**: 가계부 생성 실패 시에도 회원가입은 완료되어야 함
2. **기존 트리거 유지**: `on_ledger_created`, `on_ledger_created_categories` 트리거는 그대로 활용
3. **RLS 정책**: 트리거 내부에서 SECURITY DEFINER 사용하여 RLS 우회
4. **마이그레이션 순서**: 기존 마이그레이션(001, 002) 이후 실행되도록 003번으로 생성
5. **CLAUDE.md rethrow 규칙**: 가계부 생성은 회원가입의 부가 기능이므로 rethrow 하지 않음 (silent fail)

## 해결되는 문제들

1. **backlog의 "기본 가계부 처리 개선" 문제 완전 해결**
   - 가계부 0개 상태 제거
   - 초대 기능 항상 정상 작동

2. **사용자 경험 개선**
   - 회원가입 후 바로 사용 가능
   - 가계부 생성 단계 생략

3. **"최소 1개 유지" 정책과 완벽 일치**
   - Phase 1에서 구현한 삭제 제한과 조화

## 예상 작업량

- DB 마이그레이션: 0.2일
- Flutter 앱 수정: 0.1일
- 테스트: 0.1일
- **총 0.4일**
