# Todo: 가계부 관리 UI 개선 - 공유 멤버 정보 표시

## 메타 정보
- 생성일: 2026-01-06 12:30
- 현재 Phase: 1 (계획 수립)
- 상태: 진행중
- 반복 횟수: 0
- 예상 작업량: 0.5일 (4시간)

## 관련 문서
- PRD: .workflow/prd.md
- Backlog: .workflow/backlog.md (섹션 7)

---

## 작업 목록

### 1. 준비 단계
| 번호 | 작업 | 담당 Agent | 상태 | 결과 |
|------|------|-----------|------|------|
| 1.1 | 코드베이스 분석 | 메인 | 완료 | ledger_management_page.dart, ledger_repository.dart, ledger.dart 분석 완료 |
| 1.2 | PRD 작성 | 메인 | 완료 | .workflow/prd.md |
| 1.3 | Todo 작성 | 메인 | 완료 | .workflow/todo.md |

### 2. 구현 단계

#### 2.1 LedgerMemberModel 확인 및 수정
| 번호 | 작업 | 담당 Agent | 상태 | 파일 |
|------|------|-----------|------|------|
| 2.1.1 | LedgerMemberModel.fromJson 확인 | general-purpose | 대기 | lib/features/ledger/data/models/ledger_model.dart |
| 2.1.2 | profiles 조인 지원 확인 및 수정 (필요 시) | general-purpose | 대기 | lib/features/ledger/data/models/ledger_model.dart |

#### 2.2 Provider 추가
| 번호 | 작업 | 담당 Agent | 상태 | 파일 |
|------|------|-----------|------|------|
| 2.2.1 | ledgerMembersProvider 추가 | tdd-developer | 대기 | lib/features/ledger/presentation/providers/ledger_provider.dart |

#### 2.3 UI 구현
| 번호 | 작업 | 담당 Agent | 상태 | 파일 |
|------|------|-----------|------|------|
| 2.3.1 | _LedgerCard에서 멤버 정보 조회 | general-purpose | 대기 | lib/features/ledger/presentation/pages/ledger_management_page.dart |
| 2.3.2 | _buildMembersInfo 메서드 구현 | general-purpose | 대기 | lib/features/ledger/presentation/pages/ledger_management_page.dart |
| 2.3.3 | 멤버 표시 로직 구현 (2명/3명/4명 이상) | general-purpose | 대기 | lib/features/ledger/presentation/pages/ledger_management_page.dart |

### 3. 검증 단계
| 번호 | 작업 | 담당 Agent | 상태 | 결과 |
|------|------|-----------|------|------|
| 3.1 | 코드 리뷰 | feature-dev:code-reviewer | 대기 | - |

### 4. 최종 테스트 단계
| 번호 | 작업 | 담당 Agent | 상태 | 결과 |
|------|------|-----------|------|------|
| 4.1 | flutter analyze | 자동화 | 대기 | - |
| 4.2 | flutter build apk | 자동화 | 대기 | - |
| 4.3 | 앱 실행 테스트 | 수동 | 대기 | - |

---

## 구현 상세 가이드

### 2.1.1-2.1.2 LedgerMemberModel 확인

```dart
// lib/features/ledger/data/models/ledger_model.dart

class LedgerMemberModel {
  // fromJson에서 profiles 조인 처리 확인
  factory LedgerMemberModel.fromJson(Map<String, dynamic> json) {
    final profile = json['profiles'] as Map<String, dynamic>?;
    
    return LedgerMemberModel(
      id: json['id'] as String,
      ledgerId: json['ledger_id'] as String,
      userId: json['user_id'] as String,
      role: json['role'] as String,
      joinedAt: DateTime.parse(json['created_at'] as String),
      displayName: profile?['display_name'] as String?,
      email: profile?['email'] as String?,
      avatarUrl: profile?['avatar_url'] as String?,
    );
  }
}
```

**확인 사항:**
- `profiles` 필드가 제대로 파싱되는지 확인
- 이미 ledger.dart의 LedgerMember.fromJson(81줄)에 구현되어 있으므로 모델에도 동일하게 구현되어 있는지 확인

### 2.2.1 ledgerMembersProvider 추가

```dart
// lib/features/ledger/presentation/providers/ledger_provider.dart

@riverpod
Future<List<LedgerMember>> ledgerMembers(
  LedgerMembersRef ref,
  String ledgerId,
) async {
  final repository = ref.watch(ledgerRepositoryProvider);
  final membersModel = await repository.getMembers(ledgerId);
  
  // Model을 Entity로 변환
  return membersModel.map((model) => model.toEntity()).toList();
}
```

### 2.3.1-2.3.3 UI 구현

```dart
// lib/features/ledger/presentation/pages/ledger_management_page.dart

// _LedgerCard.build 메서드 수정 (line 103)
@override
Widget build(BuildContext context, WidgetRef ref) {
  final currentUserId = ref.watch(currentUserProvider)?.id;
  final isOwner = ledger.ownerId == currentUserId;
  
  // 멤버 정보 조회 추가
  final membersAsync = ref.watch(ledgerMembersProvider(ledger.id));

  return Card(
    // ... 기존 코드 ...
    child: InkWell(
      onTap: onSelect,
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                // ... 기존 아이콘, 이름, 배지 ...
              ],
            ),
            
            // 멤버 정보 추가 (line 172 아래)
            if (ledger.isShared)
              membersAsync.when(
                data: (members) => _buildMembersInfo(context, members, currentUserId),
                loading: () => const SizedBox.shrink(),
                error: (_, __) => const SizedBox.shrink(),
              ),
            
            // ... 기존 설명, 통화, 날짜 코드 ...
          ],
        ),
      ),
    ),
  );
}

// _buildMembersInfo 메서드 추가 (_LedgerCard 클래스 내부)
Widget _buildMembersInfo(
  BuildContext context,
  List<LedgerMember> members,
  String? currentUserId,
) {
  // 본인 제외한 멤버 목록
  final otherMembers = members
      .where((m) => m.userId != currentUserId)
      .toList();

  if (otherMembers.isEmpty) {
    return const SizedBox.shrink();
  }

  // 이름 추출 헬퍼 함수
  String getName(LedgerMember member) {
    return member.displayName ?? 
           member.email?.split('@')[0] ?? 
           '사용자';
  }

  // 멤버 수에 따라 텍스트 생성
  String memberText;
  if (otherMembers.length == 1) {
    memberText = '${getName(otherMembers[0])}님과 공유 중';
  } else if (otherMembers.length == 2) {
    memberText = '${getName(otherMembers[0])}, ${getName(otherMembers[1])}님과 공유 중';
  } else {
    final remainingCount = otherMembers.length - 2;
    memberText = '${getName(otherMembers[0])}, ${getName(otherMembers[1])} 외 ${remainingCount}명과 공유 중';
  }

  return Padding(
    padding: const EdgeInsets.only(top: 4),
    child: Row(
      children: [
        Icon(
          Icons.people_outline,
          size: 14,
          color: Colors.grey[600],
        ),
        const SizedBox(width: 4),
        Expanded(
          child: Text(
            memberText,
            style: TextStyle(
              fontSize: 12,
              color: Colors.grey[600],
            ),
            overflow: TextOverflow.ellipsis,
          ),
        ),
      ],
    ),
  );
}
```

---

## Agent 할당 전략

| Agent | 담당 작업 | 이유 |
|-------|---------|------|
| general-purpose | 2.1.1, 2.1.2, 2.3.1, 2.3.2, 2.3.3 | 기존 코드 수정 및 UI 구현 |
| tdd-developer | 2.2.1 | Provider 추가 (상태 관리) |
| feature-dev:code-reviewer | 3.1 | 코드 리뷰 |

**순차 실행:**
1. 2.1.1, 2.1.2 → 2.2.1 → 2.3.1, 2.3.2, 2.3.3 (의존성 있음)

**병렬 실행 불가**: 모든 작업이 서로 의존성이 있음

---

## 파일별 변경 사항 요약

| 파일 | 변경 내용 |
|------|----------|
| `lib/features/ledger/data/models/ledger_model.dart` | LedgerMemberModel.fromJson 확인 및 수정 (필요 시) |
| `lib/features/ledger/presentation/providers/ledger_provider.dart` | ledgerMembersProvider 추가 |
| `lib/features/ledger/presentation/pages/ledger_management_page.dart` | _LedgerCard에 멤버 정보 표시, _buildMembersInfo 메서드 추가 |

---

## 리뷰 피드백 히스토리

| 날짜 | 리뷰어 | 피드백 | 조치 |
|------|--------|--------|------|
| - | - | - | - |

---

## 테스트 결과 히스토리

| 날짜 | 테스트 종류 | 결과 | 비고 |
|------|------------|------|------|
| - | - | - | - |

---

## 변경 로그
- 2026-01-06 12:30: 초기 생성
