# PRD: 카테고리 및 거래 추가 UI 개선

## 배경 및 목적

### 문제 상황
1. **개인별 카테고리 문제**
   - 현재 가계부마다 동일한 기본 카테고리가 자동 생성됨
   - 개인별로 별도 카테고리가 생성되어 관리가 복잡함
   - 카테고리가 필수여서 유연성이 떨어짐

2. **거래 추가 화면 UX 문제**
   - 금액 입력 칸이 너무 크고 (32px 폰트) 불균형함
   - 지출명이 금액 아래에 위치하여 입력 흐름이 부자연스러움
   - 결제수단 추가/삭제는 별도 페이지로 이동해야 함
   - 카테고리는 인라인 추가가 있지만 삭제는 불가능

### 목적
- 카테고리를 선택사항으로 변경하여 유연성 향상
- 거래 추가 화면의 입력 흐름을 자연스럽게 개선
- 카테고리/결제수단 인라인 관리 기능 추가로 사용자 편의성 향상

---

## 필수 요구사항

### 1. 개인별 카테고리 제거
- [ ] DB 스키마에서 `transactions.category_id`를 nullable로 변경
- [ ] 기본 카테고리 자동 생성 트리거 제거 (선택사항)
- [ ] 거래 생성 시 카테고리 필수 검증 제거

### 2. 거래 추가 화면 레이아웃 재배치
- [ ] 입력 순서 변경: 수입/지출 선택 → 지출명 → 금액 → 날짜 → 카테고리 → 결제수단
- [ ] 금액 입력 필드 크기 축소 (32px → 24px 폰트)
- [ ] 전체 레이아웃 균형 조정

### 3. 카테고리 인라인 관리
- [ ] 카테고리 선택 영역에 추가 버튼 유지
- [ ] 각 카테고리 칩에 삭제 버튼 (x 아이콘) 추가
- [ ] 삭제 시 확인 다이얼로그 표시
- [ ] 카테고리 사용 중인 경우 삭제 제한 안내

### 4. 결제수단 인라인 관리
- [ ] 결제수단 선택 영역에 추가 버튼 추가
- [ ] 각 결제수단 칩에 삭제 버튼 (x 아이콘) 추가
- [ ] 추가 다이얼로그 구현 (이름, 아이콘, 색상)
- [ ] 삭제 시 확인 다이얼로그 표시

---

## UI/UX 요구사항

### 레이아웃 순서 (위에서 아래로)

```
1. 수입/지출 선택 (SegmentedButton)
2. 지출명 입력 (TextFormField)
3. 금액 입력 (TextFormField - 크기 축소)
4. 날짜 선택 (ListTile)
5. 카테고리 선택 (Wrap - 선택사항)
6. 결제수단 선택 (Wrap - 선택사항, 지출일 때만)
```

### 카테고리 섹션

```
카테고리 (선택)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[🍔 식비] [x]  [🚗 교통비] [x]  [🛍 쇼핑] [x]
[➕ 추가]
```

- 각 FilterChip에 삭제 버튼 (x) 표시
- "선택 안함" 옵션 추가
- 추가 버튼은 ActionChip으로 유지

### 결제수단 섹션 (지출일 때만)

```
결제수단 (선택)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[선택 안함]  [💳 신용카드] [x]  [💰 현금] [x]
[➕ 추가]
```

- 카테고리와 동일한 UI 패턴
- 추가 다이얼로그: 이름, 아이콘, 색상 입력

---

## 기술 요구사항

### 1. DB 마이그레이션

파일: `supabase/migrations/004_make_category_nullable.sql`

```sql
-- 카테고리를 선택사항으로 변경
ALTER TABLE transactions ALTER COLUMN category_id DROP NOT NULL;

-- 기본 카테고리 자동 생성 트리거 제거 (선택사항)
-- DROP TRIGGER IF EXISTS on_ledger_created_categories ON ledgers;
-- DROP FUNCTION IF EXISTS create_default_categories();
```

### 2. Flutter 코드 수정

파일: `lib/features/transaction/presentation/widgets/add_transaction_sheet.dart`

#### 변경 사항:

1. **레이아웃 순서 변경**
   - 지출명 필드를 금액 위로 이동
   - 금액 폰트 크기: 32px → 24px

2. **카테고리 필수 검증 제거**
   - 79-84줄 제거: `if (_selectedCategory == null)` 체크

3. **카테고리 삭제 버튼 추가**
   - `_buildCategoryGrid` 메서드 수정
   - FilterChip에 `onDeleted` 콜백 추가
   - `_deleteCategory(Category category)` 메서드 구현

4. **결제수단 추가/삭제 버튼 추가**
   - `_buildPaymentMethodChips` 메서드 수정
   - 추가 버튼 ActionChip 추가
   - FilterChip에 `onDeleted` 콜백 추가
   - `_showAddPaymentMethodDialog()` 메서드 구현
   - `_deletePaymentMethod(PaymentMethod method)` 메서드 구현

### 3. Repository 수정

파일: `lib/features/payment_method/data/repositories/payment_method_repository.dart`

- `createPaymentMethod()` 메서드 확인/구현
- `deletePaymentMethod()` 메서드 확인/구현

---

## 성공 기준

### 기능 테스트
- [ ] 카테고리 없이 거래 생성 가능
- [ ] 지출명 → 금액 → 카테고리 순서로 자연스러운 입력
- [ ] 카테고리 인라인 추가/삭제 동작
- [ ] 결제수단 인라인 추가/삭제 동작
- [ ] 금액 입력 필드 크기가 적절함

### 품질 테스트
- [ ] Flutter analyze 통과
- [ ] Flutter build 성공
- [ ] 앱 실행 테스트 통과

### 데이터 무결성
- [ ] 기존 거래 데이터 유지
- [ ] 카테고리 삭제 시 사용 중인 거래 보호
- [ ] 결제수단 삭제 시 사용 중인 거래 보호

---

## 제약 사항

1. **기존 데이터 보호**: 이미 category_id가 있는 거래는 유지
2. **삭제 제한**: 사용 중인 카테고리/결제수단 삭제 시 경고 메시지
3. **CLAUDE.md 원칙 준수**: 에러는 반드시 rethrow

---

## 향후 개선 가능 사항

- [ ] 카테고리/결제수단 편집 기능
- [ ] 카테고리/결제수단 순서 변경 기능
- [ ] 자주 사용하는 카테고리 상단 고정
- [ ] 사용 빈도에 따른 자동 정렬
