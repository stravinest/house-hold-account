# PRD: 가계부 관리 UI 개선 - 공유 멤버 정보 표시

## 작성일
2026-01-06

## 배경 및 목적

### 현재 상황
- 가계부 관리 페이지에서 공유된 가계부와 개인 가계부의 구분이 아이콘으로만 표시됨
- 누구와 공유했는지 멤버 정보가 표시되지 않음
- 사용자가 공유 상태를 한눈에 파악하기 어려움

### 목적
- 공유된 가계부의 멤버 정보를 명확하게 표시
- 공유 상태를 시각적으로 개선하여 사용자 경험 향상
- 공유 기능의 가시성 향상

---

## 필수 요구사항

### 1. 멤버 정보 조회 기능
- [ ] Provider에서 각 가계부의 멤버 정보 조회
- [ ] 멤버 이름(display_name) 또는 이메일 표시
- [ ] 멤버 수 계산 (본인 포함)

### 2. UI 개선
- [ ] 공유 멤버 정보를 가계부 카드에 표시
- [ ] 멤버 표시 형식: "홍길동, 이영희 외 1명과 공유 중"
- [ ] 멤버가 2명 이하: 모든 이름 표시
- [ ] 멤버가 3명 이상: 2명만 표시하고 나머지는 "외 N명"

### 3. 성능 최적화
- [ ] 멤버 정보를 효율적으로 로드 (필요 시 캐싱)
- [ ] 가계부 목록 로딩 시 멤버 정보도 함께 로드

---

## UI/UX 요구사항

### 현재 UI (ledger_management_page.dart:107-254)

```
┌─────────────────────────────────────┐
│ 👥  내 가계부               [사용중] │
│     공유 가계부                      │
│                                     │
│     설명 텍스트 (선택)              │
│     💰 KRW   📅 2026.01.06         │
└─────────────────────────────────────┘
```

### 개선된 UI

```
┌─────────────────────────────────────┐
│ 👥  내 가계부               [사용중] │
│     공유 가계부                      │
│     👤 홍길동, 이영희 외 1명과 공유 중  │  <- 추가
│                                     │
│     설명 텍스트 (선택)              │
│     💰 KRW   📅 2026.01.06         │
└─────────────────────────────────────┘
```

또는

```
┌─────────────────────────────────────┐
│ 👤  개인 가계부              [사용중] │
│     개인 가계부                      │
│                                     │  <- 공유 정보 없음
│     설명 텍스트 (선택)              │
│     💰 KRW   📅 2026.01.06         │
└─────────────────────────────────────┘
```

### 멤버 표시 규칙

| 멤버 수 | 표시 형식 | 예시 |
|--------|----------|------|
| 1명 (본인만) | 표시 안함 | - |
| 2명 | "OOO님과 공유 중" | "홍길동님과 공유 중" |
| 3명 | "OOO, XXX님과 공유 중" | "홍길동, 이영희님과 공유 중" |
| 4명 이상 | "OOO, XXX 외 N명과 공유 중" | "홍길동, 이영희 외 2명과 공유 중" |

---

## 기술 요구사항

### 1. Provider 수정

파일: `lib/features/ledger/presentation/providers/ledger_provider.dart`

```dart
// 각 가계부의 멤버 정보를 조회하는 Provider 추가
@riverpod
Future<List<LedgerMember>> ledgerMembers(
  LedgerMembersRef ref,
  String ledgerId,
) async {
  final repository = ref.watch(ledgerRepositoryProvider);
  return repository.getMembers(ledgerId);
}
```

### 2. UI 컴포넌트 수정

파일: `lib/features/ledger/presentation/pages/ledger_management_page.dart`

#### _LedgerCard 위젯 수정 (line 89-255)

```dart
class _LedgerCard extends ConsumerWidget {
  // ... 기존 코드 ...

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currentUserId = ref.watch(currentUserProvider)?.id;
    final isOwner = ledger.ownerId == currentUserId;
    
    // 멤버 정보 조회 추가
    final membersAsync = ref.watch(ledgerMembersProvider(ledger.id));

    return Card(
      // ... 기존 카드 설정 ...
      child: InkWell(
        onTap: onSelect,
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // ... 기존 Row (아이콘, 이름, 사용중 배지) ...
              
              // 멤버 정보 표시 추가
              if (ledger.isShared)
                membersAsync.when(
                  data: (members) => _buildMembersInfo(context, members, currentUserId),
                  loading: () => const SizedBox.shrink(),
                  error: (_, __) => const SizedBox.shrink(),
                ),
              
              // ... 기존 코드 (설명, 통화, 날짜) ...
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildMembersInfo(
    BuildContext context,
    List<LedgerMember> members,
    String? currentUserId,
  ) {
    // 본인 제외한 멤버 목록
    final otherMembers = members
        .where((m) => m.userId != currentUserId)
        .toList();

    if (otherMembers.isEmpty) {
      return const SizedBox.shrink();
    }

    String memberText;
    if (otherMembers.length == 1) {
      final name = otherMembers[0].displayName ?? 
                   otherMembers[0].email?.split('@')[0] ?? 
                   '사용자';
      memberText = '$name님과 공유 중';
    } else if (otherMembers.length == 2) {
      final name1 = otherMembers[0].displayName ?? 
                    otherMembers[0].email?.split('@')[0] ?? 
                    '사용자';
      final name2 = otherMembers[1].displayName ?? 
                    otherMembers[1].email?.split('@')[0] ?? 
                    '사용자';
      memberText = '$name1, $name2님과 공유 중';
    } else {
      final name1 = otherMembers[0].displayName ?? 
                    otherMembers[0].email?.split('@')[0] ?? 
                    '사용자';
      final name2 = otherMembers[1].displayName ?? 
                    otherMembers[1].email?.split('@')[0] ?? 
                    '사용자';
      final remainingCount = otherMembers.length - 2;
      memberText = '$name1, $name2 외 ${remainingCount}명과 공유 중';
    }

    return Padding(
      padding: const EdgeInsets.only(top: 4),
      child: Row(
        children: [
          Icon(
            Icons.people_outline,
            size: 14,
            color: Colors.grey[600],
          ),
          const SizedBox(width: 4),
          Text(
            memberText,
            style: TextStyle(
              fontSize: 12,
              color: Colors.grey[600],
            ),
          ),
        ],
      ),
    );
  }
}
```

### 3. 데이터 모델 확인

파일: `lib/features/ledger/data/models/ledger_model.dart`

- `LedgerMemberModel.fromJson()` 메서드가 profiles 조인을 지원하는지 확인
- 필요 시 수정

---

## 성공 기준

### 기능 테스트
- [ ] 개인 가계부: 멤버 정보 표시 안함
- [ ] 2명 공유: "OOO님과 공유 중" 표시
- [ ] 3명 공유: "OOO, XXX님과 공유 중" 표시
- [ ] 4명 이상 공유: "OOO, XXX 외 N명과 공유 중" 표시
- [ ] display_name이 없으면 email 앞부분 사용

### 성능 테스트
- [ ] 가계부 목록 로딩 시간이 현저히 느려지지 않음
- [ ] 멤버 정보 조회 에러 시 UI가 깨지지 않음

### 품질 테스트
- [ ] Flutter analyze 통과
- [ ] Flutter build 성공
- [ ] 앱 실행 테스트 통과

---

## 위험 요소 및 고려사항

1. **성능 문제**:
   - 가계부가 많을 경우 각 가계부마다 멤버 조회 쿼리 발생
   - 해결: Riverpod의 자동 캐싱 활용, 필요 시 debounce

2. **에러 처리**:
   - 멤버 조회 실패 시 UI가 깨지면 안됨
   - 해결: `when(error: () => SizedBox.shrink())`로 에러 시 숨김

3. **사용자 이름 없는 경우**:
   - display_name이 null인 경우 email 앞부분 사용
   - email도 없으면 "사용자"로 표시

---

## 예상 작업량

- 코드베이스 분석: 0.5시간 (완료)
- Provider 수정: 0.5시간
- UI 구현: 1.5시간
- 테스트 및 디버깅: 1시간
- 코드 리뷰 및 수정: 0.5시간

**총 예상 시간**: 약 4시간 (0.5일)

---

## 향후 개선 가능 사항

- [ ] 멤버 아바타 이미지 표시
- [ ] 멤버 역할(owner, editor, viewer) 표시
- [ ] 가계부 카드 클릭 시 멤버 상세 정보 보기
- [ ] 멤버 초대 바로가기 버튼
