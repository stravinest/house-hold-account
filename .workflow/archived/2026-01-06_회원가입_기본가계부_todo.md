# Todo: 회원가입 시 기본 가계부 자동 생성

## 메타 정보
- 생성일: 2026-01-06 15:30
- 현재 Phase: 1 (계획 수립)
- 상태: 대기
- 반복 횟수: 0
- 예상 작업량: 0.4일

## 관련 문서
- PRD: .workflow/prd.md
- Backlog: .workflow/backlog.md (4. 기본 가계부 처리 개선)
- DB Schema: supabase/migrations/001_initial_schema.sql

---

## 작업 목록

### 1. 준비 단계
| 번호 | 작업 | 담당 Agent | 상태 | 결과 |
|------|------|-----------|------|------|
| 1.1 | 코드베이스 분석 | Planner | 완료 | auth_provider.dart, ledger_repository.dart, 001_initial_schema.sql 분석 완료 |
| 1.2 | PRD 작성 | Planner | 완료 | .workflow/prd.md |
| 1.3 | Todo 작성 | Planner | 완료 | .workflow/todo.md |

### 2. 구현 단계

#### 2.1 DB 마이그레이션 (Primary)
| 번호 | 작업 | 담당 Agent | 상태 | 파일 |
|------|------|-----------|------|------|
| 2.1.1 | 마이그레이션 파일 생성 | general-purpose | 대기 | supabase/migrations/003_auto_create_default_ledger.sql |
| 2.1.2 | handle_new_user() 함수 수정 | general-purpose | 대기 | 003_auto_create_default_ledger.sql |

#### 2.2 Flutter 앱 (Secondary)
| 번호 | 작업 | 담당 Agent | 상태 | 파일 |
|------|------|-----------|------|------|
| 2.2.1 | AuthService에 LedgerRepository 의존성 추가 | general-purpose | 대기 | auth_provider.dart |
| 2.2.2 | signUpWithEmail()에 백업 가계부 생성 로직 추가 | general-purpose | 대기 | auth_provider.dart |

### 3. 검증 단계
| 번호 | 작업 | 담당 Agent | 상태 | 결과 |
|------|------|-----------|------|------|
| 3.1 | 코드 리뷰 | code-reviewer | 대기 | - |

### 4. 최종 테스트 단계
| 번호 | 작업 | 담당 Agent | 상태 | 결과 |
|------|------|-----------|------|------|
| 4.1 | flutter analyze | 자동화 | 대기 | - |
| 4.2 | flutter test | 자동화 | 대기 | - |
| 4.3 | flutter build | 자동화 | 대기 | - |
| 4.4 | 신규 회원가입 테스트 | app-test-agent | 대기 | - |
| 4.5 | 기존 사용자 로그인 테스트 | app-test-agent | 대기 | - |

---

## 구현 상세 가이드

### 2.1.1-2.1.2 DB 마이그레이션

```sql
-- 003_auto_create_default_ledger.sql
-- 회원가입 시 기본 가계부 자동 생성

-- handle_new_user() 함수 수정 (profiles + 기본 가계부 생성)
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
    new_ledger_id UUID;
BEGIN
    -- 1. profiles 테이블에 사용자 정보 생성
    INSERT INTO profiles (id, email, display_name)
    VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data->>'display_name', split_part(NEW.email, '@', 1))
    );

    -- 2. 기본 가계부 생성
    INSERT INTO ledgers (name, currency, owner_id, is_shared)
    VALUES ('내 가계부', 'KRW', NEW.id, FALSE)
    RETURNING id INTO new_ledger_id;

    -- 참고: ledger_members와 categories는 기존 트리거가 자동 생성
    -- - on_ledger_created: owner를 ledger_members에 추가
    -- - on_ledger_created_categories: 기본 카테고리 생성

    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 트리거는 이미 존재하므로 재생성 불필요
-- (on_auth_user_created 트리거가 handle_new_user 함수를 호출)
```

### 2.2.1-2.2.2 Flutter 앱 수정

```dart
// auth_provider.dart

import '../../../ledger/data/repositories/ledger_repository.dart';

class AuthService {
  final _auth = SupabaseConfig.auth;
  final _client = SupabaseConfig.client;
  final _ledgerRepository = LedgerRepository();  // 추가

  // 이메일/비밀번호 회원가입
  Future<AuthResponse> signUpWithEmail({
    required String email,
    required String password,
    String? displayName,
  }) async {
    debugPrint('[AuthService] signUpWithEmail 시작');
    // ... 기존 디버그 로그 유지

    try {
      final response = await _auth.signUp(
        email: email,
        password: password,
        data: displayName != null ? {'display_name': displayName} : null,
      );

      debugPrint('[AuthService] signUp 응답 받음');
      // ... 기존 디버그 로그 유지

      // 백업 안전장치: DB 트리거가 실패했을 경우를 대비
      // 가계부 생성 실패해도 회원가입은 완료되어야 하므로 try-catch로 감싸고 silent fail
      await _ensureDefaultLedgerExists();

      return response;
    } catch (e, st) {
      debugPrint('[AuthService] signUpWithEmail 에러: $e');
      debugPrint('[AuthService] 에러 타입: ${e.runtimeType}');
      debugPrint('[AuthService] 스택 트레이스: $st');
      rethrow;
    }
  }

  // 백업 안전장치: 가계부가 0개면 기본 가계부 생성
  Future<void> _ensureDefaultLedgerExists() async {
    try {
      debugPrint('[AuthService] 기본 가계부 존재 여부 확인');
      final ledgers = await _ledgerRepository.getLedgers();

      if (ledgers.isEmpty) {
        debugPrint('[AuthService] 가계부가 없음. 기본 가계부 생성 시작');
        await _ledgerRepository.createLedger(
          name: '내 가계부',
          currency: 'KRW',
        );
        debugPrint('[AuthService] 기본 가계부 생성 완료');
      } else {
        debugPrint('[AuthService] 기본 가계부 이미 존재: ${ledgers.length}개');
      }
    } catch (e) {
      // 가계부 생성 실패는 회원가입을 막지 않음 (silent fail)
      // 사용자가 나중에 수동으로 가계부를 생성할 수 있음
      debugPrint('[AuthService] 기본 가계부 확인/생성 중 에러 (무시됨): $e');
    }
  }

  // ... 나머지 메서드 유지
}
```

---

## 파일별 변경 사항 요약

| 파일 | 변경 내용 |
|------|----------|
| `supabase/migrations/003_auto_create_default_ledger.sql` | 신규 생성 - handle_new_user() 함수 수정 |
| `lib/features/auth/presentation/providers/auth_provider.dart` | LedgerRepository import 추가, _ensureDefaultLedgerExists() 메서드 추가, signUpWithEmail()에서 호출 |

---

## 리뷰 피드백 히스토리

| 날짜 | 리뷰어 | 피드백 | 조치 |
|------|--------|--------|------|
| - | - | - | - |

---

## 테스트 결과 히스토리

| 날짜 | 테스트 종류 | 결과 | 비고 |
|------|------------|------|------|
| - | - | - | - |

---

## 변경 로그
- 2026-01-06 15:30: 초기 생성 (Planner)
