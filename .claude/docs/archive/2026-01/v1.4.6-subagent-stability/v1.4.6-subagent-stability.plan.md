# v1.4.6 Sub Agent 호출 안정화 계획서

> **Summary**: Plugin agent 호출 시 `bkit:` prefix 누락 문제 해결
>
> **Project**: bkit Vibecoding Kit
> **Version**: 1.4.5 → 1.4.6
> **Author**: Claude Code + bkit PDCA
> **Date**: 2026-01-28
> **Status**: Draft

---

## 1. Overview

### 1.1 Purpose

bkit 플러그인의 sub agent 호출 시 발생하는 `Agent type 'gap-detector' not found` 오류를 해결하여, 플러그인 사용자들이 안정적으로 모든 bkit agent를 사용할 수 있도록 함.

### 1.2 Background

Claude Code의 Task tool을 통한 plugin agent 호출 시, 반드시 `{plugin-name}:` prefix가 필요함. 그러나 bkit 코드베이스 전반에서 agent 이름이 prefix 없이 참조되어 실제 호출이 실패함.

**문제 상황:**
```javascript
// 현재 코드에서 반환하는 값
Task(subagent_type="gap-detector", prompt="...")  // ❌ 실패

// Claude Code가 기대하는 값
Task(subagent_type="bkit:gap-detector", prompt="...")  // ✅ 성공
```

### 1.3 Related Documents

- 분석 문서: `docs/03-analysis/v1.4.6-subagent-stability.analysis.md`
- Claude Code 공식 문서: [Create custom subagents](https://code.claude.com/docs/en/sub-agents)
- 관련 GitHub Issues: #19276, #17524, #18982

---

## 2. Scope

### 2.1 In Scope

- [x] `lib/common.js` - `matchImplicitAgentTrigger` 함수 수정
- [x] `scripts/user-prompt-handler.js` - Agent 추천 출력 수정
- [x] `skills/pdca/SKILL.md` - `agents:` 매핑 수정
- [x] `skills/code-review/SKILL.md` - `agent:` 필드 수정
- [x] `skills/starter/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-8-review/SKILL.md` - `agents:` 매핑 수정
- [x] `skills/phase-7-seo-security/SKILL.md` - `agent:` 필드 수정
- [x] `skills/enterprise/SKILL.md` - `agents:` 매핑 수정
- [x] `skills/dynamic/SKILL.md` - `agent:` 필드 수정
- [x] `skills/zero-script-qa/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-4-api/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-6-ui-integration/SKILL.md` - `agent:` 필드 수정
- [x] `skills/development-pipeline/SKILL.md` - `agent:` 필드 수정
- [x] `skills/desktop-app/SKILL.md` - `agent:` 필드 수정
- [x] `skills/mobile-app/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-1-schema/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-2-convention/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-3-mockup/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-5-design-system/SKILL.md` - `agent:` 필드 수정
- [x] `skills/phase-9-deployment/SKILL.md` - `agent:` 필드 수정
- [x] `skills/bkit-rules/SKILL.md` - Agent 참조 테이블 수정
- [x] `hooks/session-start.js` - Trigger 테이블 수정
- [x] `.claude-plugin/plugin.json` - 버전 업데이트

### 2.2 Out of Scope

- `agents/*.md` 파일 내부의 `name:` 필드 (변경 불필요 - Claude Code가 자동으로 prefix 추가)
- `skills/claude-code-learning/SKILL.md`의 `claude-code-guide` (built-in agent이므로 prefix 불필요)
- Claude Code 플랫폼 자체 버그 (Anthropic에서 해결 필요)

---

## 3. Requirements

### 3.1 Functional Requirements

| ID | Requirement | Priority | Status |
|----|-------------|----------|--------|
| FR-01 | 모든 bkit plugin agent 참조에 `bkit:` prefix 추가 | Critical | Pending |
| FR-02 | Built-in agent 참조는 prefix 없이 유지 | High | Pending |
| FR-03 | session-start hook의 Agent Trigger 테이블 업데이트 | Medium | Pending |
| FR-04 | bkit-rules의 Agent 가이드 테이블 업데이트 | Medium | Pending |
| FR-05 | plugin.json 버전을 1.4.6으로 업데이트 | High | Pending |

### 3.2 Non-Functional Requirements

| Category | Criteria | Measurement Method |
|----------|----------|-------------------|
| 호환성 | Claude Code v2.1.x와 완전 호환 | E2E 테스트 |
| 안정성 | Agent 호출 성공률 100% | 수동 테스트 |
| 유지보수성 | 상수화를 통한 중앙 관리 | 코드 리뷰 |

---

## 4. Success Criteria

### 4.1 Definition of Done

- [x] 모든 skill 파일의 `agent:` 필드에 적절한 prefix 적용
- [x] `matchImplicitAgentTrigger` 함수가 prefix 포함 agent 이름 반환
- [x] session-start hook의 Trigger 테이블 업데이트
- [x] plugin.json 버전 1.4.6으로 업데이트
- [x] 수동 테스트 통과

### 4.2 Quality Criteria

- [x] 모든 bkit agent가 Task tool로 호출 가능
- [x] Claude Code 세션 시작 시 오류 없음
- [x] 기존 기능 회귀 없음

---

## 5. Risks and Mitigation

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| 일부 파일 누락으로 불완전한 수정 | High | Medium | 파일 목록 체크리스트 사용 |
| Built-in agent에 잘못된 prefix 추가 | Medium | Low | Built-in agent 목록 명시 |
| 플랫폼 버전 변경으로 규칙 변경 | Low | Low | Claude Code 릴리스 노트 모니터링 |

---

## 6. Technical Design

### 6.1 Agent 분류

#### bkit Plugin Agents (prefix 필수: `bkit:`)

| Agent Name | 현재 참조 | 수정 후 참조 |
|------------|----------|-------------|
| gap-detector | `gap-detector` | `bkit:gap-detector` |
| code-analyzer | `code-analyzer` | `bkit:code-analyzer` |
| pdca-iterator | `pdca-iterator` | `bkit:pdca-iterator` |
| report-generator | `report-generator` | `bkit:report-generator` |
| starter-guide | `starter-guide` | `bkit:starter-guide` |
| design-validator | `design-validator` | `bkit:design-validator` |
| qa-monitor | `qa-monitor` | `bkit:qa-monitor` |
| pipeline-guide | `pipeline-guide` | `bkit:pipeline-guide` |
| bkend-expert | `bkend-expert` | `bkit:bkend-expert` |
| enterprise-expert | `enterprise-expert` | `bkit:enterprise-expert` |
| infra-architect | `infra-architect` | `bkit:infra-architect` |

#### Built-in Agents (prefix 불필요)

| Agent Name | 설명 |
|------------|------|
| `Explore` | 코드베이스 탐색 |
| `Plan` | 구현 계획 설계 |
| `general-purpose` | 범용 에이전트 |
| `Bash` | 명령어 실행 |
| `claude-code-guide` | Claude Code 가이드 |

### 6.2 수정 대상 파일 상세

#### A. Critical (핵심 로직)

**1. `lib/common.js` - matchImplicitAgentTrigger 함수 (line 1974-2053)**

현재:
```javascript
const implicitPatterns = {
  'gap-detector': { patterns: [...] },
  'code-analyzer': { patterns: [...] },
  'pdca-iterator': { patterns: [...] },
  'report-generator': { patterns: [...] },
  'starter-guide': { patterns: [...] }
};
```

수정 후:
```javascript
const implicitPatterns = {
  'bkit:gap-detector': { patterns: [...] },
  'bkit:code-analyzer': { patterns: [...] },
  'bkit:pdca-iterator': { patterns: [...] },
  'bkit:report-generator': { patterns: [...] },
  'bkit:starter-guide': { patterns: [...] }
};
```

**2. `skills/pdca/SKILL.md` (line 21-25)**

현재:
```yaml
agents:
  analyze: gap-detector
  iterate: pdca-iterator
  report: report-generator
```

수정 후:
```yaml
agents:
  analyze: bkit:gap-detector
  iterate: bkit:pdca-iterator
  report: bkit:report-generator
```

#### B. High (Skill 파일 수정)

| 파일 | 현재 값 | 수정 후 |
|------|---------|---------|
| `skills/code-review/SKILL.md` | `agent: code-analyzer` | `agent: bkit:code-analyzer` |
| `skills/starter/SKILL.md` | `agent: starter-guide` | `agent: bkit:starter-guide` |
| `skills/dynamic/SKILL.md` | `agent: bkend-expert` | `agent: bkit:bkend-expert` |
| `skills/zero-script-qa/SKILL.md` | `agent: qa-monitor` | `agent: bkit:qa-monitor` |
| `skills/phase-4-api/SKILL.md` | `agent: qa-monitor` | `agent: bkit:qa-monitor` |
| `skills/phase-6-ui-integration/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |
| `skills/phase-7-seo-security/SKILL.md` | `agent: code-analyzer` | `agent: bkit:code-analyzer` |
| `skills/phase-9-deployment/SKILL.md` | `agent: infra-architect` | `agent: bkit:infra-architect` |
| `skills/development-pipeline/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |
| `skills/desktop-app/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |
| `skills/mobile-app/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |
| `skills/phase-1-schema/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |
| `skills/phase-2-convention/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |
| `skills/phase-3-mockup/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |
| `skills/phase-5-design-system/SKILL.md` | `agent: pipeline-guide` | `agent: bkit:pipeline-guide` |

**`skills/phase-8-review/SKILL.md` (복수 agent)**

현재:
```yaml
agents:
  default: code-analyzer
  validate: design-validator
  gap: gap-detector
```

수정 후:
```yaml
agents:
  default: bkit:code-analyzer
  validate: bkit:design-validator
  gap: bkit:gap-detector
```

**`skills/enterprise/SKILL.md` (복수 agent)**

현재:
```yaml
agents:
  default: enterprise-expert
  infra: infra-architect
  architecture: enterprise-expert
```

수정 후:
```yaml
agents:
  default: bkit:enterprise-expert
  infra: bkit:infra-architect
  architecture: bkit:enterprise-expert
```

#### C. Medium (문서/가이드)

**`skills/bkit-rules/SKILL.md` (line 117-123)**

현재:
```markdown
| User Intent | Auto-Invoke Agent |
|-------------|-------------------|
| "code review", "security scan" | `code-analyzer` |
| "design review", "spec check" | `design-validator` |
| "gap analysis" | `gap-detector` |
| "report", "summary" | `report-generator` |
| "QA", "log analysis" | `qa-monitor` |
| "pipeline", "which phase" | `pipeline-guide` |
```

수정 후:
```markdown
| User Intent | Auto-Invoke Agent |
|-------------|-------------------|
| "code review", "security scan" | `bkit:code-analyzer` |
| "design review", "spec check" | `bkit:design-validator` |
| "gap analysis" | `bkit:gap-detector` |
| "report", "summary" | `bkit:report-generator` |
| "QA", "log analysis" | `bkit:qa-monitor` |
| "pipeline", "which phase" | `bkit:pipeline-guide` |
```

**`hooks/session-start.js` - getTriggerKeywordTable 함수 (line 437-459)**

현재:
```javascript
| verify, 검증, ... | gap-detector | Run Gap analysis |
| improve, 개선, ... | pdca-iterator | Auto-improvement |
| analyze, 분석, ... | code-analyzer | Code quality analysis |
| report, 보고서, ... | report-generator | Generate completion report |
| help, 도움, ... | starter-guide | Beginner guide |
```

수정 후:
```javascript
| verify, 검증, ... | bkit:gap-detector | Run Gap analysis |
| improve, 개선, ... | bkit:pdca-iterator | Auto-improvement |
| analyze, 분석, ... | bkit:code-analyzer | Code quality analysis |
| report, 보고서, ... | bkit:report-generator | Generate completion report |
| help, 도움, ... | bkit:starter-guide | Beginner guide |
```

---

## 7. Implementation Order

### Phase 1: Core Logic 수정 (Critical)

1. `lib/common.js` - `matchImplicitAgentTrigger` 함수 수정
2. `scripts/user-prompt-handler.js` - 출력 메시지 확인 (변경 불필요 - common.js에서 처리)

### Phase 2: PDCA Skill 수정 (High)

3. `skills/pdca/SKILL.md` - agents 매핑 수정

### Phase 3: 기타 Skill 파일 수정 (High)

4. `skills/code-review/SKILL.md`
5. `skills/starter/SKILL.md`
6. `skills/dynamic/SKILL.md`
7. `skills/zero-script-qa/SKILL.md`
8. `skills/phase-4-api/SKILL.md`
9. `skills/phase-6-ui-integration/SKILL.md`
10. `skills/phase-7-seo-security/SKILL.md`
11. `skills/phase-8-review/SKILL.md`
12. `skills/phase-9-deployment/SKILL.md`
13. `skills/enterprise/SKILL.md`
14. `skills/development-pipeline/SKILL.md`
15. `skills/desktop-app/SKILL.md`
16. `skills/mobile-app/SKILL.md`
17. `skills/phase-1-schema/SKILL.md`
18. `skills/phase-2-convention/SKILL.md`
19. `skills/phase-3-mockup/SKILL.md`
20. `skills/phase-5-design-system/SKILL.md`

### Phase 4: 문서/가이드 수정 (Medium)

21. `skills/bkit-rules/SKILL.md` - Agent 가이드 테이블 수정
22. `hooks/session-start.js` - Trigger 테이블 수정

### Phase 5: 버전 업데이트

23. `.claude-plugin/plugin.json` - 버전 1.4.6으로 업데이트

---

## 8. Test Plan

### 8.1 수동 테스트 시나리오

```bash
# 테스트 1: Gap Detector 호출
1. Claude Code 세션 시작
2. "설계대로 구현됐어?" 입력
3. 확인: Task tool이 "bkit:gap-detector"로 호출하는지 확인
4. 확인: Agent가 정상 실행되는지 확인

# 테스트 2: PDCA Skill을 통한 Agent 호출
1. "/pdca analyze test-feature" 실행
2. 확인: bkit:gap-detector가 호출되는지 확인

# 테스트 3: Code Review Skill을 통한 Agent 호출
1. "/code-review src/" 실행
2. 확인: bkit:code-analyzer가 호출되는지 확인

# 테스트 4: Session Start Hook
1. 새 Claude Code 세션 시작
2. 확인: Trigger 테이블에 bkit: prefix가 표시되는지 확인
```

### 8.2 회귀 테스트

- [ ] 모든 skill이 정상 로드됨
- [ ] Hook이 정상 실행됨
- [ ] Claude Code Guide (built-in) 호출 정상
- [ ] 기존 PDCA 플로우 정상 작동

---

## 9. Rollback Plan

문제 발생 시:
1. Git revert로 이전 커밋으로 복원
2. plugin.json 버전을 1.4.5로 되돌림

```bash
git revert HEAD
# 또는 특정 커밋으로 복원
git checkout v1.4.5 -- lib/common.js skills/ hooks/
```

---

## 10. Next Steps

1. [x] Plan 문서 작성 완료
2. [ ] Design 문서 작성 (필요시 - 이 케이스는 단순 수정이므로 생략 가능)
3. [ ] 구현 시작
4. [ ] 테스트 수행
5. [ ] 커밋 및 PR 생성

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-01-28 | Initial draft based on analysis document | Claude Code |
