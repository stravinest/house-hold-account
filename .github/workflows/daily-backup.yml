name: Daily Supabase Backup

on:
  schedule:
    # 매일 한국시간 새벽 3시 (UTC 18:00)
    - cron: '0 18 * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      STORAGE_BUCKET: db-backups

    steps:
      - name: REST API로 테이블 데이터 백업
        run: |
          DATE=$(date +%Y%m%d)
          BACKUP_DIR="backup_${DATE}"
          mkdir -p "$BACKUP_DIR"

          # house 스키마의 주요 테이블 목록
          TABLES=(
            "profiles"
            "ledgers"
            "ledger_members"
            "categories"
            "transactions"
            "budgets"
            "ledger_invites"
            "payment_methods"
            "learned_sms_formats"
            "pending_transactions"
            "fcm_tokens"
            "notification_settings"
            "push_notifications"
            "learned_push_formats"
            "fixed_expense_categories"
            "fixed_expense_settings"
            "app_versions"
          )

          FAILED=0
          for TABLE in "${TABLES[@]}"; do
            echo "Backing up: $TABLE"
            HTTP_STATUS=$(curl -s -o "$BACKUP_DIR/${TABLE}.json" -w "%{http_code}" \
              -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
              -H "apikey: $SUPABASE_SERVICE_KEY" \
              -H "Accept: application/json" \
              -H "Prefer: count=exact" \
              "${SUPABASE_URL}/rest/v1/${TABLE}?select=*&limit=100000")

            if [ "$HTTP_STATUS" = "200" ]; then
              ROWS=$(python3 -c "import json; print(len(json.load(open('$BACKUP_DIR/${TABLE}.json'))))" 2>/dev/null || echo "?")
              echo "  OK: ${TABLE} (${ROWS} rows)"
            else
              echo "  WARN: ${TABLE} (HTTP $HTTP_STATUS) - 테이블이 없거나 접근 불가"
              rm -f "$BACKUP_DIR/${TABLE}.json"
              FAILED=$((FAILED + 1))
            fi
          done

          # JSON 파일들을 tar.gz로 압축
          BACKUP_FILE="house_${DATE}.tar.gz"
          tar -czf "$BACKUP_FILE" "$BACKUP_DIR"
          ls -lh "$BACKUP_FILE"

          echo "BACKUP_FILE=$BACKUP_FILE" >> "$GITHUB_ENV"
          echo "DATE=$DATE" >> "$GITHUB_ENV"

          if [ "$FAILED" -gt 10 ]; then
            echo "ERROR: 대부분의 테이블 백업 실패"
            exit 1
          fi

      - name: Supabase Storage 업로드
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/upload_response.txt -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/octet-stream" \
            -H "x-upsert: true" \
            --data-binary @"$BACKUP_FILE" \
            "${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}/${BACKUP_FILE}")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Upload OK: ${STORAGE_BUCKET}/${BACKUP_FILE}"
          else
            echo "Upload FAILED (HTTP $HTTP_STATUS)"
            cat /tmp/upload_response.txt
            exit 1
          fi

      - name: 30일 이전 백업 삭제
        run: |
          CUTOFF=$(date -d '30 days ago' +%Y%m%d)

          curl -s \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -d '{"prefix":"house_","limit":100}' \
            "${SUPABASE_URL}/storage/v1/object/list/${STORAGE_BUCKET}" \
          | python3 -c "
          import sys, json
          files = json.load(sys.stdin)
          old = []
          for f in files:
              name = f.get('name', '')
              if name.startswith('house_') and name.endswith('.tar.gz'):
                  d = name[6:14]
                  if d < '$CUTOFF':
                      old.append(name)
          for name in old:
              print(name)
          " 2>/dev/null | while read -r OLD_FILE; do
            curl -s -o /dev/null \
              -X DELETE \
              -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
              "${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}/${OLD_FILE}"
            echo "Deleted: $OLD_FILE"
          done
