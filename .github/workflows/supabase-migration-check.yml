name: Supabase Migration Check

on:
  push:
    paths:
      - 'supabase/migrations/**'
  pull_request:
    paths:
      - 'supabase/migrations/**'

jobs:
  check-migrations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check migration files syntax
        run: |
          echo "Checking migration files..."
          for file in supabase/migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              # SQL íŒŒì¼ ê¸°ë³¸ ë¬¸ë²• ì²´í¬ (ê°„ë‹¨í•œ ê²€ì¦)
              if grep -q "CREATE TABLE\|ALTER TABLE\|CREATE FUNCTION\|CREATE POLICY" "$file"; then
                echo "âœ“ $file looks valid"
              else
                echo "âš ï¸ $file might be empty or invalid"
              fi
            fi
          done

      - name: List migration files
        run: |
          echo "=== Migration Files ==="
          ls -lh supabase/migrations/
          echo ""
          echo "Total migrations: $(ls -1 supabase/migrations/*.sql 2>/dev/null | wc -l)"

      - name: Check for dangerous operations
        run: |
          echo "Checking for potentially dangerous operations..."

          # DROP TABLE ì²´í¬
          if grep -r "DROP TABLE" supabase/migrations/*.sql; then
            echo "âš ï¸ WARNING: DROP TABLE found in migrations"
            echo "Please review carefully before merging"
          fi

          # DROP COLUMN ì²´í¬
          if grep -r "DROP COLUMN" supabase/migrations/*.sql; then
            echo "âš ï¸ WARNING: DROP COLUMN found in migrations"
            echo "Please review carefully before merging"
          fi

          # TRUNCATE ì²´í¬
          if grep -r "TRUNCATE" supabase/migrations/*.sql; then
            echo "âš ï¸ WARNING: TRUNCATE found in migrations"
            echo "Please review carefully before merging"
          fi

      - name: Check RLS policies
        run: |
          echo "Checking Row Level Security policies..."

          # RLS ì •ì±… í™•ì¸
          if grep -r "CREATE POLICY\|ALTER POLICY\|DROP POLICY" supabase/migrations/*.sql; then
            echo "âœ“ RLS policies found"
            echo "Please ensure policies are correctly defined"
          fi

          # RLS í™œì„±í™” í™•ì¸
          if grep -r "ENABLE ROW LEVEL SECURITY" supabase/migrations/*.sql; then
            echo "âœ“ RLS enabled on tables"
          fi

      - name: Comment migration summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const migrationsDir = 'supabase/migrations';
            const files = fs.readdirSync(migrationsDir)
              .filter(f => f.endsWith('.sql'))
              .sort();

            let body = '## ğŸ“Š Supabase Migration Summary\n\n';
            body += `**Total migrations**: ${files.length}\n\n`;
            body += '### Migration Files:\n';

            files.forEach(file => {
              const content = fs.readFileSync(path.join(migrationsDir, file), 'utf8');
              const lines = content.split('\n').length;
              body += `- \`${file}\` (${lines} lines)\n`;
            });

            body += '\n### âš ï¸ Review Checklist:\n';
            body += '- [ ] RLS policies are correctly defined\n';
            body += '- [ ] No accidental DROP operations\n';
            body += '- [ ] Tested on development environment\n';
            body += '- [ ] Backward compatible (if needed)\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ì„ íƒì : Supabase ë¡œì»¬ í™˜ê²½ì—ì„œ ì‹¤ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
  # test-migrations:
  #   runs-on: ubuntu-latest
  #
  #   services:
  #     postgres:
  #       image: supabase/postgres:15.1.0.117
  #       env:
  #         POSTGRES_PASSWORD: postgres
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Run migrations
  #       run: |
  #         # Supabase ë¡œì»¬ í™˜ê²½ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
  #         echo "Migration test would run here"
